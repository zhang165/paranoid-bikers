<!DOCTYPE html>
{% load staticfiles %}
<html>

	<head>
		<link rel="stylesheet" type="text/css" href="{% static 'style.css' %}">
    <script type="text/javascript"
  src="https://maps.googleapis.com/maps/api/js?libraries=visualization&sensor=true_or_false">
</script>
		<script type="text/javascript">

var myLatlng = new google.maps.LatLng(49.255, -123.121);
var map;
var heatmap;
var markers = [];

function toggleHeatmap() {
  heatmap.setMap(heatmap.getMap() ? null : map);
}

function toggleMarkers() {
    for (var i = 0; i < markers.length; i++) {
    markers[i].setMap(markers[i].getMap() ? null : map);
  }
}

function initialize() {

var styleArray = [{"featureType":"water","elementType":"all","stylers":[{"hue":"#7fc8ed"},{"saturation":55},{"lightness":-6},{"visibility":"on"}]},{"featureType":"water","elementType":"labels","stylers":[{"hue":"#7fc8ed"},{"saturation":55},{"lightness":-6},{"visibility":"off"}]},{"featureType":"poi.park","elementType":"geometry","stylers":[{"hue":"#83cead"},{"saturation":1},{"lightness":-15},{"visibility":"on"}]},{"featureType":"landscape","elementType":"geometry","stylers":[{"hue":"#f3f4f4"},{"saturation":-84},{"lightness":59},{"visibility":"on"}]},{"featureType":"landscape","elementType":"labels","stylers":[{"hue":"#ffffff"},{"saturation":-100},{"lightness":100},{"visibility":"off"}]},{"featureType":"road","elementType":"geometry","stylers":[{"hue":"#ffffff"},{"saturation":-100},{"lightness":100},{"visibility":"on"}]},{"featureType":"road","elementType":"labels","stylers":[{"hue":"#bbbbbb"},{"saturation":-100},{"lightness":26},{"visibility":"on"}]},{"featureType":"road.arterial","elementType":"geometry","stylers":[{"hue":"#ffcc00"},{"saturation":100},{"lightness":-35},{"visibility":"simplified"}]},{"featureType":"road.highway","elementType":"geometry","stylers":[{"hue":"#ffcc00"},{"saturation":100},{"lightness":-22},{"visibility":"on"}]},{"featureType":"poi.school","elementType":"all","stylers":[{"hue":"#d7e4e4"},{"saturation":-60},{"lightness":23},{"visibility":"on"}]}];

  var styledMap = new google.maps.StyledMapType(styleArray,
    {name: "Parking Locations"});

  var mapOptions = {
    zoom: 12,
    center: myLatlng,
    mapTypeControlOptions: {
      mapTypeIds: [google.maps.MapTypeId.ROADMAP, 'map_style']
    }
  };

map = new google.maps.Map(document.getElementById('map'), mapOptions);
var icon = "{% static 'images/icon.png' %}";
var me = "{% static 'images/me.png' %}";
var directionsService = new google.maps.DirectionsService();
var directionsDisplay = new google.maps.DirectionsRenderer({suppressMarkers: true, preserveViewport: true});

var heatmapData = [
{% for c in crimes %}
  new google.maps.LatLng({{c.lat}}, {{c.lon}}),

{% endfor %}
];

heatmap = new google.maps.visualization.HeatmapLayer({
  data: heatmapData,
  "radius": 7,
  "opacity": 0.8,
  "maxIntensity": 15
});

heatmap.setMap(map);

navigator.geolocation.getCurrentPosition(geoSuccess);

function geoSuccess(position){
	myLatlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
            var marker = new google.maps.Marker({
            position: myLatlng,
            map: map,
            icon: me,
            clickable: true,
            draggable: false,
        });

    //map.setCenter(myLatlng);
}

map.mapTypes.set('map_style', styledMap);
  map.setMapTypeId('map_style');


var highlow = document.getElementById("highlow");

{% for m in markers %}
var point = new google.maps.LatLng({{m.lon}}, {{m.lat}});
var marker = new google.maps.Marker({
            position: point,
            map: map,
            icon: icon,
            clickable: true,
            draggable: false,
        });

marker.info = new google.maps.InfoWindow({
});

google.maps.event.addListener(marker, 'click', function() {

  marker.info.setContent(
  	'<b><p>Parking Location</p></b>'+
  	'<p>{{m.rate}}<br>'+
  	'{{m.credit_card}}<br>'+
  	'{{m.location}}<br>'+
  	'{{m.intersection}}'+
  '<br></p><a href=http://maps.google.com/maps?q=&layer=c&cbll={{m.lon}},{{m.lat}} target="_blank"><img src="https://maps.googleapis.com/maps/api/streetview?size=350x180&location={{m.lon}},{{m.lat}}&heading=151.78&pitch=-0.76"></a>')
  marker.info.open(map, this);
  calcRoute();

  function calcRoute(){
  	var request = {
      origin: myLatlng,
      destination: new google.maps.LatLng({{m.lon}}, {{m.lat}}),
      travelMode: google.maps.TravelMode.DRIVING
    };

     directionsService.route(request, function(response, status) {
      if (status == google.maps.DirectionsStatus.OK) {
        directionsDisplay.setDirections(response);
        directionsDisplay.setMap(map);
      } else {
        alert("Error: " + status);
      }
    });
	
}

});

markers.push(marker);

{% endfor %}
// var kmlLayer = new google.maps.KmlLayer({
// 	url: data,
// 	map: map,
// 	suppressInfoWindows: false,
//   });
  }

google.maps.event.addDomListener(window, 'load', initialize);

</script>

	</head>
	
	<body>
		<table height="100%" width="100%" border="0">
		<tr>
		<td align="left" valign="center">
		<img src="{% static 'images/banner.png' %}">
		</td>
		<td alight="right" valign="center">
			<div class="login">
		{% block body %}
		{% load socialaccount %}
		{% if user.is_authenticated %}
			<a href="{% url 'account_logout' %}">Sign Out</a>
		{% else %}
			<a href="{% url 'account_login' %}">Sign In</a><br>
			<a href="{% url 'account_signup' %}">Sign Up</a><br>
			<a href="{% provider_login_url "google" %}">Sign in with Google</a><br>
			<a href="{% provider_login_url "facebook" method="oauth2" %}">Sign in with Facebook</a><br>
      <a href="{% provider_login_url "twitter" %}">Sign in with Twitter</a><br>
		{% endif %}
		{% endblock %}
		</div>
	</td>
		</tr>
		  <tr>
			<td valign="top" align="center"  colspan = "2">
		 <div id="map"></div>
		  </td>
		  </tr>
		  <tr>
        
		  	<td valign="top" align="left">
		  		<select id="filter-menu">
  					<option value="high">High Crime</option>
  					<option value="low" selected="selected">Low Crime</option>
				</select>
        <button onclick="toggleMarkers()">Toggle Parking Locations</button>

      </td>
        <td valgin="top" align="right">
          <button onclick="toggleHeatmap()">Toggle Crime Heatmap</button>
</td>
		  
      
		  </tr>

		</table>
	</body>
</html>